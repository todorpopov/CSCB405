# Физическа организация на базите от данни

## Процесът „проектиране на физическата база“
- Управляваните от СУБД данни са устойчиви - съществуват независимо дали с тях работи някакво приложение или не . 
- Данните не могат да се съхраняват изцяло в оперативната памет на компютъра поради нейната енергозависимост и ограничен обем. 
- Обичайно СУБД обработва данните в оперативната памет, а ги съхранява на външна памет, като осъществява обмена чрез услугите на операционната система.  Напоследък се предлагат решения – например HANA  на SAP и TimesTen  на Oracle, при които базата се разполага изцяло в оперативната памет на компютъра. 
- Всяка готова СУБД предлага различни възможности за организация на данните. Проектантът на базата избира от тях за да осигури ефективност на предполагаемите преобладаващи операции с базата.
- „Проектиране на физическата база" -  избор на най-подходящите за дадено приложение методи за организация на данните. 
- Извършва след проектирането на схемата и обхваща определянето на пътища за ефективен достъп до данните, задаването на системни параметри като размер на блока, буферите, протокол за възстановяване на данните при софтуерни и хардуерни повреди и др.
- Кое налага внимателно проектиране на физическата база – бързото нарастване на структурираните (релационни кортежи), полуструктурираните (XML) и неструктурирани данни (аудио и видео).


- Основни стъпки при проектирането на база от данни
    - Анализ на изискванията.
    - Проектиране на логическата база.
    - Проектиране на физическата база.
    - Реализация на базата, мониторинг и настройване.

## Елементи на физическата база от данни
- Обикновено данните се съхраняват като файлове със записи. Физическата база от данни представлява множество от взаимно-свързани записи от различен тип, групирани във файлове. Записът е съвкупност от свързани полета с данни, които описват обектите с техните атрибути и връзки. 
- Множеството от имената на полетата заедно със съответстващия им тип образуват формата на записа. 
- Освен специфичните за дадено приложение данни, записът съдържа указатели и служебна информация, необходима за идентифицирането и обработването му от СУБД.
- От разположението на записите върху диска зависи ефективен ли е достъпът на СУБД до тях.

- При обработка на данни съществена е разликата между физически и логически аспект на данните. 
    - Логическият аспект отразява естеството на данните, независимо от физическите подробности на съхраняването и представянето им. 
    - Физическият аспект изразява начина на съхраняването и представянето им върху определен носител.
- Логически запис - множеството от данни, което представлява едно цяло за потребителя, т.е. това е съвкупността от полетата на записа. 
- Физически запис - единицата информация, която реално се чете от едно устройство или се записва на него или най-малкият обем данни, предаван между паметта и диска при обработката на данните -  синоними :  “блок” или “страница”.

- Файловете биват:
    - с неблокувани записи; физически запис = логически;
    - с блокувани записи; физически запис = няколко логически записа.
- Освен това във файла записите могат да бъдат:
    - с постоянна или фиксирана дължина;
    - с променлива дължина.
- Физически файлът може да се съхранява на диска в
    - последователни блокове;
    - свързани чрез указатели блокове;
    - клъстери.

- Файлове на базата =  множества от еднотипни записи с постоянна или променлива дължина. 
- Записите се групират съобразно блоковете на диска като в един блок се поместват по няколко записа в зависимост от дължината им. Блоков фактор се нарича числото bfr = [B/R], където B е размерът на блока, а R - дължина на записа. 
- Файлът може да се съхранява на диска в последователни или свързани чрез указатели блокове. 
- Клъстерите представляват комбинация от двата начина на съхранение.
- Всеки файл е снабден с челен блок (хедър), който съдържа информация за адресите на блоковете и формàта на записа (дължина на полетата, наредба, начин на запис в блока, дали е с фиксирана дължина или не и др.).

- От гледна точка на базите операциите върху файлове са:
    - от тип “търсене”
        - не променят данните, а само намират определени записи, така че техните полета да се изследват и съдържанието им да се извежда.
    - от тип “обновяване”
        - променят съдържанието на файла - въвеждане на нов запис, изтриване на съществуващ запис, модификация стойностите на някои полета.

- Критерий за търсене
    - Определя условията, които записите трябва да удовлетворяват.
    - Условие за избор от общ вид: отделните булеви изрази могат да бъдат свързани с and, or, not. 
    - В общия случай може да се формулира сложно условие, съдържащо булев израз.
    - Използва се и при двата типа операции.

- Файлова система - елемент от дадена операционна система, която осигурява управление на файловете, свързани с отделните приложения. 
- Предоставя контролиран достъп до файл по име, многопотребителска работа и стандартизирани входно/изходни процедури. 
- Повечето файлови системи могат да намират запис, само ако критерия за търсене е просто условие.
- Сложното условие за избор обикновено се разлага от СУБД на прости подусловия, които се използват за намиране на нужните записи.
- Ако група от записи удовлетворяват един и същ критерий за търсене, то се намира само първия (има се предвид физическата им наредба върху диска). 
- Достъпът до останалите записи, които удовлетворяват същото условие се осъществява чрез допълнителни операции. 
- Последният намерен запис се нарича "текущ".
- Следващите операции към базата започват от последния текущ запис.

- Действителните операции върху файлове зависят от конкретната операционна система. 
- Видове: 
    - Операции, работещи с файл като логическа единица:
        - open, close, create, copy, rename, delete, type
    - Операции, работещи със записите в рамките на даден файл:
        - read, write, update, insert, delete
- Начинът на съхранение и достъпът до записите в базата зависи от файловата организация.

- Команди на СУБД за достъп до записите в базата 
    - Open – подготвя файла за четене или запис; запазва поне два буфера за прехвърляне на негови блокове; намира челния блок на файла и установява неговия указател към началото му.
    - Reset – установява указателя на отворен файл към началото му.
    - Find (или Locate) – намира първия запис във файла, който удовлетворява условието за търсене; прехвърля при необходимост съответния блок в буфер от главната памет и го прави текущ запис.
    - Read (или Get) – копира текущия запис от буфера в програмни променливи.
    - FindNext – намира следващия запис във файла, който удовлетворява условието за търсене; прехвърля при необходимост съответния блок в буфер от главната памет и го прави текущ запис.
    - Delete – изтрива текущия запис.
    - Modify – актуализира съдържанието на някои от полетата в записа.
    - Insert – вмъква нов запис във файла.
    - Close – прекратява достъпа до файла чрез освобождаване на буферите и извършване на необходимите почистващи операции.

## Видове файлови организации
- Файлова организация = физическата организация на данните от файла в записи, блокове и структури за достъп. Тя включва начина, по който записите са разпределени върху даден носител и са свързани помежду си. 
- Съществуват три основни типа файлови организации:
    - Неструктуриран файл (heap, sequential);
    - Подреден файл (ordered);
    - Директен файл (hash).
- С всяка файлова организация се свързват определени методи за достъп.

- Метод за достъп - множество от програми, които позволяват прилагането на операции (read, write, open, close,….) към даден файл.
- Методът за достъп се състои от: 
    - структура от данни - определя начина на съхранение на блоковете с данни и свързаните с тях допълнителни структури за достъп в паметта;
    - механизъм за търсене - определя пътя за достъп, т.е. начина за достигане до записите с нужната информация, напр. последователно търсене, двоично търсене, директно търсене.
- Всяка комбинация на структура от данни с механизъм за търсене дава различен метод за достъп. 
- Следователно методът за достъп определя как се съхраняват и намират записите от файл с определена файлова структура.

- Командите за обработка на базата биват: 
    - извличане на всички записи от даден тип (последователен достъп);
    - избор на един запис от даден тип (директен достъп);
    - избор на група от записи, удовлетворяващи някакво условие (достъп с булева заявка).
- С всеки тип обработка се свързват ефективни методи за достъп до данните.

- Неструктуриран (последователен) файл
    - Записите се поместват така както са въведени физически. 
    - Нови записи се добавят винаги в края на блока, а ако няма място се добавя нов блок. 
    - Използва се когато данните в базата се натрупват първоначално и още не е ясно какви обработки ще се изискват. 
    - Добавянето на нов запис е изключително ефективно.
    - Търсенето на определен запис е бавно, преглеждат се  последователно всички записи (линейно търсене).
    - Изтриването на произволен запис става като се отбележи за изтрит, или като се изтрие физически.  Това налага  периодична реорганизация на файла от АБД за да се използува празното пространство на диска и за да се ускорят обработките.
    - За да се прочете файлът по определен начин се налага или сортиране, или създаване на допълнителни структури за достъп.

- Подреден (сортиран) файл
    - Записите с еднаква дължина физически могат да се подредят по стойностите на едно или няколко от полетата на записа, наречени сортиращи полета.
    - Търсенето на записи в реда, наложен от сортиращото поле става бързо. 
    - Може да се провежда двоично търсене когато в условието за избор участва полето, по което е сортиран файлът. 
    - Въвеждането и изтриването на записи в подреден файл е трудно, поради спазване на наложения от стойностите на сортиращото поле ред.
    - Сортирани файлове не се използват често при базите от данни, защото се заема допълнително място на диска, поради това че се прави копие на първоначалния файл и има опасност от получаване на противоречива база.

- Директен файл
    - При директните файловете местоположението на записите се изчислява с помощта на хеш - функция, която трансформира стойността на определено поле във физически адрес на блок, наречен клетка на хеш-таблицата – виж следващ слайд.
    - Обикновено се извършва хеширане чрез деление с верижно препълване. Трансформирането на адреса става чрез деление на стойността на дадено поле от записа (обикновено се избира поле с уникални стойности – хеш поле) на части и прилагане на аритметична функция към всяка част. Така се получава единствено число - адрес, който след това се преобразува във физически адрес на диска. 
    - Достъпът до физическия адрес позволява извличането на съществуващ запис или записването на нов.
    - При опит да се въведе запис в заета клетка на хеш-таблицата се получава колизия и съответно препълване. На новопостъпващия запис трябва да се намери място. 
    - Съществуват различни подходи, но най-често се заделят блокове за препълване, свързани помежду си с указатели -оттам и термина "верижно препълване". 
    - Хеширането от своя страна може да бъде статично или динамично. Записите в един хеш файл са произволно разпределени върху блокове от диска и затова понякога хеш-файловете се наричат файлове с директен достъп. 
    - Търсенето на записи в хеш-файл е ефективно само когато в критерия за търсене участвува хеш-полето. Затова хеш-файлове се използуват сравнително рядко при базите от данни.

- Основните файлови организации се прилагат когато всички записи в даден файл са от един и същ тип. 
- При повече от приложенията, обаче се установяват връзки между записи от различни файлове с помощта на свързващи полета като чужд ключ при релационния модел или връзките между обектите при обектно-ориентираните модели. 
- Файловите организации при обектните, или при йерархичните и мрежови СУБД, реализират тези връзки чрез физически указатели, като записите се поместват в една област (клъстер). 
- При първоначалното зареждане на хранилищата, данните произлизат от различни източници и се съдържат в различни файлове, които се поместват в един клъстер, за да се подложат на преформатиране и почистване. 
- Възможно е използването и на други структури от данни като B-дървета за файлова организация.

- Нови хардуерни решения за ускоряване извличането на данните
    - Масиви от независими дискове (redundant arrays of independent disks – RAID) - подобряват ефективността на дисковата памет за работа с мултимедийна информация. 
    - Локални мрежи за съхранение (Storage Area Networks – SAN) –  онлайн периферни устройства за запазване на данни представляват възли във високоскоростна мрежа, към която при нужда се прикачват сървърите. 
    - Специализирани устройства, които се включват към мрежата (Network-Аttached Storage – NAS) - осигуряват памет за споделяне на файлове като позволяват добавянето на дискови ресурси, без да се налага изключване или обновяване на сървъри; съхраняват различни файлове (заместват традиционните файлови сървъри).
    - Промени в инфраструктурата за съхранение на данните в организацията – благодарение на облачните технологии и  разпределените архитектури - обектно-ориентирани хранилища

## Методи за проектиране на физическата база

- Индексиране
    - Индексирането е метод за ефективно търсене на записи в база от данни. 
    - Към файла с данните се създават допълнителни структури за достъп – индекси. Индексите спомагат за по-бързото намиране на нужния запис и са ефективно средство за достъп при задаване на критерий за търсене. 
    - Индексът е допълнителна структура към основния файл с данни, чиято цел е да ускори извличането на търсената информация - избягва се последователното претърсване.
    - Файлът с основните данни се нарича главен или файл с данни, а допълнителните структури – индекси или индексни файлове. Тя се дефинира обикновено върху едно поле, което се нарича индексно.

    - Индексът съхранява всяка стойност на избраното индексно поле и указател към блока с данни, в който се съдържа записа със съответната стойност на индексното поле.
    - Достъпът до записите може да бъде:
        - последователен;
        - чрез индекса.
    - Видове индекси:
        - главен индекс - индекс, дефиниран върху поле с уникални стойности, по което физически е подреден даден файл; представлява сортиран файл, чиито записи са с постоянна дължина и съдържат две полета: стойността на избраното поле с уникални стойности и адрес на блока, който съдържа търсения запис.
        - клъстер индекс - главен индекс, ако полето, по което е подреден файла е с повтарящи се стойности; представлява сортиран файл, съдържащ две полета: различните стойности на избраното поле и адрес на блока, който съдържа търсения запис.
        - вторичен индекс - дефинира се върху произволно поле на файла, по което се търси често.
            - средство за бърз достъп до съдържанието на файл, чиито записи са сортирани, хеширани или неструктурирани;
            - предоставя логическо сортиране на записите по избраното индексиращо поле;
            - върху даден файл могат да се изградят произволен брой вторични индекси;
            - бива компактен (dense) или разреден (sparse). При компактния индекс за всяка стойност на избраното за индексно поле се създава запис. При разредения индекс запис в индексния файл се създава запис само за определени стойности.

    - Един файл може да има най-много един главен или клъстер индекс, защото физически може да бъде подреден само по стойностите на едно поле.
    - В допълнение могат да се дефинират произволен брой вторични индекси. 
    - В много системи индексът не е част от файла с данни, а може да се създава и променя динамично. Затова се нарича структура за достъп. 
    - При нарастване размера на индексния файл се прибягва до създаването на индекси на много нива като по този начин се намалява обхвата на търсенето

    - Начини за индексиране  на базата: инвертирани файлове, различни видове дървовидни структури, многосписъчни файлове……………..
    - Обикновено релационните СУБД използват различни видове дървета: 
        - В-дърво - при СУБД Oracle, DB2, Ingress, Sybase, Microsoft SQL Server.  Реализира се чрез специализирана структура В+ дърво, при които се елиминират голяма част от указателите, като се използва индексен файл. Така обхождането на дървото е ефективно. 
    - При СУБД от трето поколение се прилагат R дървета и се разработват нови методи за индексиране.
    - Разработени са методи за индексиране и съответни структури за реализация, когато индексиращото поле се състои от няколко елемента (съставен индекс). Предлагат се структури за достъп, които са подобни на индексирането, но прилагат хеширане или използват някои от функциите, заложени в СУБД - (Oracle).

- Клъстериране
    - Таблици които имат общи колони (предполага се, че те често се използват съвместно) се съхраняват физически заедно и образуват клъстер или група (Oracle). 
    - Общите колони образуват клъстер-ключ (cluster key), който се съхранява само на едно място и подобрява едновременно достъпа и до двете таблици.
    
    - В Oracle са реализирани:
        - индексирани клъстери  (indexed clusters) - записите с еднаква стойност на клъстер-ключа се съхраняват на едно място. 
        - хеш-клъстери  (hash clusters) -  прилага се хешираща функция върху клъстер-ключа на записа и всички записи с една и същи хеш ключ се съхраняват заедно на диска. 
    - В клъстер се групират таблици, чиито колони участват често в условия за съединение и тези колони не се актуализират често. 
    - Таблици, чиито редове трябва да се преглеждат последователно или размера им не превишава повече от един или два блока в Oracle, не се включват в клъстери. 
    - За създаването на различните видове клъстери в SQL е предвидена специална команда CREATE CLUSTER. 
    - Недостатък - данните могат да се групират върху диска по единствен начин.

- Материализиране на потребителски представи
    - Материализирана представа (materialized view) - резултат от изпълнението на заявки, при които се извличат данни от няколко таблици.
    - Ускоряват изпълнението на често повтарящи се заявки или заявки, при които се изчисляват агрегатни функции. 
    - Практически е невъзможно да се съхраняват всички представи поради ограничения обем на паметта. Задача на проектанта е да определи кои от тях да се материализират. 
    - Обикновено заявките се анализират и от тях се избират онези, при които се наблюдава изпълнение на голям брой входно-изходни дискови операции. 
    - Материализирането на потребителски представи се прилага при хранилищата с данни и средствата за интерактивна аналитична обработка.

- Разделяне (partitioning)
    - Разделянето е метод за намаляване на натоварването в произволен хардуерен компонент на системата - например данните от един диск могат да се разпределят върху няколко диска с цел уравновесяване на натоварването на устройството и предотвратяване на забавянето на входно-изходните операции. 
    - При разделянето по обхват (range partitioning) данните в дадена таблица се сортират и се разделят на сегменти (таблици с по-малък брой редове) с приблизително еднакъв брой от записи. Всяка група или фрагмент се разполага на отделен диск и може да се обработва независимо от останалите.

    - Преимущества на метода:
        - съхраняват се таблици с по-големи размери поради повишените възможности за адресиране на техните записи;
        - елиминира се обработването на част от сегментите, което позволява на компилатора да избира ефективен план за изпълнението на заявките;
        - подобрено администриране на базата, защото АБД изпълнява специализираните команди (BACKUP, LOAD и др.) върху отделни сегменти, а не върху цялата таблица;
        - неявно клъстериране на данните при входно-изходните операции.
    - Разделянето по обхват с известни модификации е реализирано в СУБД DB2, Informix и Oracle.

- Други техники
    - Компресиране - позволява разполагането на по-големи обеми от данни в определено пространство на диска като се осигурява по-бърз достъп при необходимост от преглеждане на голяма част от записите.
    - Образуване на групи (data striping) – данните, до които е необходим едновременен достъп, се разпределят върху няколко диска с цел уравновесяване на натоварването и паралелно изпълнение на входно-изходните операции; подходяща при наличието на съответен хардуер - например масиви от независими дискове.
    - Дублиране на данните върху няколко диска – необходимостта от обновяване на всички копия едновременно, както и заемането на допълнителна памет, е съществен недостатък.
    - Денормализиране на данните – с оглед ефективното изпълнение на заявки и транзакции към базата се допуска нарушаване на изискването за трета нормална форма, като част от отношенията се съхраняват в по-ниски нормални форми; решението се взима след анализ на честотата на изпълнение, обем и приоритет на обработките, като се отчитат страничните ефекти от евентуална загуба на състоятелността на базата; целта е да се намали изпълнението на операцията „съединение“. 

## Фактори при проектиране на физическата база

- Изпълнявани заявки и трансакции
    - За всяка заявка, с която се извличат данни от базата се събират данни за:
        - таблици (файлове), до които се осъществява достъп;
        - колони, които участват в условието за избор;
        - тип на сравненията в условието за търсене;
        - колони, които участват в операция „съединение“;
        - колони, чиито стойности се извеждат в резултата от заявката.
    - Обикновено структури за достъп, например индекси, се дефинират върху колоните, които участват в условие за избор или операция „съединение“.

    - За всяка заявка или трансакция, които обновяват базата се събират данни за:
        - файлове, които се обновяват;
        - тип на операцията;
        - участващи в операции „изтриване“ или „модифициране“ стойности на колони.
    - Структури за достъп се дефинират върху колоните, които участват операции „изтриване“ или „модифициране“, защото чрез тях намирането на необходимия за обработване запис става по-бързо. 

- Честота на изпълнение на трансакции и заявки
    - Целта е да се оцени участието на всяка колона в условия за търсене или съединение. Практиката показва, че 80% от обработките се извършват от около 20% от заявките или транзакциите. Поради тези причини статистика се води само за тези 20%, които са най-често използвани.

- Изисквания към време за отговор на трансакции и заявки
    - Указват влияние върху определяне на структурите за достъп. Например колоните, по които се осъществява извличане на данни от заявка с ограничения във времето за отговор, е добре да се индексират.

- Честота на обновяване на записите в даден файл
    - При файлове, чиито записи често се обновяват трябва да се дефинират минимален брой структури за достъп, защото самите те подлежат на променяне всеки път когато се въведе нов елемент. Допълнителните системни операции, изпълнявани от СУБД, могат да забавят обработките значително.
- Ключови колони
    - Обикновено структури за достъп се задават върху колони, които са главни или кандидат ключове в таблицата. По този начин се спазва изискването за уникалност на стойностите на ключа като идентификатор на отделните редове.


