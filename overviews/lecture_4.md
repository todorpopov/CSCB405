# SQL

## Основни заявки на SQL
- Характеристики на SQL
    - Интегриран език, съдържащ като език за дефиниране на данните, така и език за обработване на данните.
    - SQL може да се вгражда в език за програмиране – например C, Pascal и др.
    - Разработен е стандарт, наречен SQL2 (SQL’92).
    - Разработен е стандарт, наречен SQL3, който разширява стандартния език SQL с обектно-ориентирани понятия.
    - Допълнително са разработени следните стандарти: 
        - през 2003 г. -SQL:2003 (ISO, 2003);
        - през лятото на 2008 г.- SQL:2008 (ISO/IEC, 2008); 
        - през 2011 - SQL:2011 (ISO, 2011). 
    - Последна версия на стандарта (ISO/IEC, 2016) е предложена през 2016 г.

- Основни понятия при SQL
    - SQL използва термините "таблица", "редица" и "колона" съответно за "релация", "кортеж" и "атрибут". 
    - Среда (environment) – съдържа единствена база.
    - База от данни – състои се от множеството на всички схеми, дефинирани в дадена среда.
    - Схема (schema)– състои се от една или няколко таблици, потребителски представи (view) и права (privileges), принадлежащи на даден потребител.
    - Каталог (Information Schema) – именувано множество на схемите в дадена среда.
    - Пространство на базата (dbspace) – логическо заделяне на място за базата, което е част от общото пространство. Всеки потребител има достъп до поне едно такова пространство, което от своя страна се състои от определен брой сегменти, осигурени от АБД. Отделните пространства притежават различни нива на заключване.

- SQL притежава единствен оператор за извличане на данни от базата – SELECT, който се различава силно от операцията “селекция” на релационната алгебра.
- За разлика от формалния релационен модел, SQL допуска съществуването на два напълно идентични реда в една таблица.
- Съществуват опции и команди, които осигуряват различимост на отделните редове в дадена таблица, т.е. резултатът да представлява  множество.

- Основен елемент на езика SQL 
    - SELECT <списък от колони> FROM   <списък от таблици> WHERE  <условие>

    - След оператора WHERE могат да се задават условия:
        - за избор - Dname = 'Research'
        - за съединение - Dnumber = Dno
    - В общия случай могат да се задават произволен брой условия за избор и съединение след оператора WHERE.

- В SQL е допустимо две колони да носят едно и също име при условие, че се намират в отделни таблици. 
    - Тогава при формулирането на заявките е необходимо уточняването на името на колоната чрез това на съответната й таблица.

- Липсващ WHERE – безусловен избор на всички редове.
- Ако след FROM е зададена повече от една таблица, по подразбиране се извеждат всички възможни комбинации от редове – декартово произведение.
- Изпуснато условие за съединение – декартово произведение.

- Символът * означава ВСИЧКИ КОЛОНИ

- Множествена операция – обединение (UNION)
    - В някои версии се реализират сечение и разлика на две таблици.
    - Резултатната таблица не съдържа дублирани редове.

- Оператор LIKE 
    - Служи за сравняване на части от даден низ или за търсене на определен подниз.
    - Символите ‘%’ (в някои реализации на SQL се използва ‘*’) и ‘_’ са запазени. 
    - ‘%’ заменя произволен брой символи в низа, а ‘_’ – точно един, който и да е символ. 


- В SQL са предвидени основните агрегатни функции:
    -Агрегатните функции се прилагат само върху единствена колона.

    - COUNT – връща броя на стойностите в дадена колона или броя на редовете в таблицата;
    - SUM – връща сумата от стойностите на посочената колона;
    - MIN – връща най-малката стойност в посочената колона;
    - MAX – връща най-голямата стойност в посочената колона;
    - AVG – изчислява средна стойност в посочената колона.

- COUNT, MIN и MAX могат да се прилагат върху числови или нечислови полета
- SUM и AVG се прилагат само върху числови полета. 

- Всички функции първо изключват стойностите Null и работят върху останалите стойности.

- COUNT(*) представлява специален начин на използване на COUNT и връща броя на редовете в указана таблица, независимо от наличните стойности Null.

- Агрегатните функции се използват само в оператора SELECT или заедно с ключовата дума HAVING. 

- Групирането е възможно чрез използвaнето оператора GROUP BY. 
- След него се изброяват колоните, по чиито стойности таблицата ще се дели на групи. Тези колони се изброяват задължително и след SELECT. 
    - SELECT <списък от атрибути> FROM <списък от релации> [WHERE <условие>] [GROUP BY <атрибути на групиране>]

- Задаване на условие върху групите 
    - Използва се оператора HAVING, след който се формулира необходимото условие
    - Агрегатните функции се изчислят само групите, които отговарят на указаното условие.

- Сортирането на резултатната таблица по стойностите на една или няколко колони, възходящо или низходящо е възможно чрез оператора ORDER BY.
    - След него се изброяват колоните, по чиито стойности таблицата ще се сортира.
    - По подразбиране сортирането се извършва възходящо. Ключовата дума DESC позволява низходяща подредба. 

- В SQL има три операции за обновяване на базата:
    - Всяка команда за обновяване важи само за единствена таблица.

    - INSERT – въвежда редове в указаната таблица.
        - Позволява добавянето на един или няколко реда в указаната таблица. Има няколко варианта.
        - Задават се стойностите на всяка колона, като се спазва редът, наложен при дефинирането на таблицата. 
    - DELETE – премахва редове от указаната таблица.
        - Позволява премахването на онези редове от указаната таблица, които удовлетворяват зададеното условие. 
        - Ако не е зададено явно условие всички редове се изтриват и таблицата остава празна. 
        - Окончателното премахване на таблица от базата става с командата DROP. 
    - UPDATE – модифицира данни в указаната таблица.
        - Променя стойностите на указаните колони, удовлетворяващи зададеното условие. 
        - Имената на колоните, подлежащи на актуализация се указват след ключовата дума SET.

- Команди CREATE/DROP
    - Използват се за създаване и унищожаване на различни обекти:

    - Създаване / унищожаване на база 
        - CREATE DATABASE database_name
        - DROP DATABASE database_name

    - Създаване /унищожаване на пространство.
        - ACQUIRE [PUBLIC | PRIVATE] DBSPACE NAMED dbspace_name [option [option]...]
        - Option: LOCK = {DBSPACE| PAGE | ROW} 
        - DROP DBSPACE dbspace_name`

    - Създаване / унищожаване на схеми.
        - Преди да се създаде дадена таблица е необходимо да бъдат създадени базата и пространството, което ще съдържа таблиците. 
        - Потребителят трябва да бъде упълномощен, т.е. да му бъдат дадени права да създава таблици и схеми. 
        - Преди операцията базата трябва да се направи активна с помощта на една от следните команди:
            - USE database_name
            - START database_name

## Дефиниране на данните
- Понятието “SQL-схема” се използва за групирането на таблици и други конструкции, които принадлежат на едно и също приложение. 
- Схемата се дефинира чрез име и идентификатор за правата, показващ кой потребител има достъп до нея.
- Елементите на схемата включват таблици, ограничения за цялостност, потребителски представи, домейни и други конструкции, които я описват напълно. 
- Командата за създаване на схема има вида:
    - CREATE SCHEMA schema_name AUTHORIZATION owner_name;

- Описанието на всяка създадена схема се пази в каталога. 
- В него специална схема, наречена INFORMATION_SCHEMA съхранява данни относно всички елементи на всички схеми и ги предоставя на потребители със съответните права.
- Схема се изтрива по следния начин:
    - DROP SCHEMA database schema_name {CASCADE /RESTRICT};
- Опцията CASCADE се използва за премахване на схемата заедно с всичките й елементи. 
    - DROP SCHEMA COMPANY CASCADE;
- Опцията RESTRICT премахва схемата само ако преди това са премахнати всички нейни елементи.

- Създаване / унищожаване на таблица.
    - Таблица се създава с помощта на командата CREATE TABLE, като се указва съответното име, описват се изграждащите я колони, като за всяка от тях се задава тип на данните, дефинират се отделните типове ограничения и ключове.
    - Типовете данни попадат в една от следните категории:
        - Цифрови (numeric).
            - цели числа с различен размер: INT, and SMALLINT
            - реални числа с различна точност: FLOAT, REAL, DOUBLE PRECISION
        - Символни низове (character string).
            - с фиксирана дължина CHAR(n)
            - с променлива дължина CHAR VARYING (n) 
        - Битови низове (bit-string).
            - с фиксирана дължина BIT(n)
            - с променлива дължина BIT VARYING (n)
        - Дата / час (date, time).
            - DATE – с формат yyyy-mm-dd;
            - TIME - с формат hh:mm:ss;
            - TIMESTAMP – комбинация от горните два типа;
            - INTERVAL - показва число, което може да се добавя или изважда от горните три типа данни.

- Върху всяка колона може да се задава ограничението NOT NULL.
- Главният ключ се задава чрез PRIMARY KEY и UNIQUE, а чуждите ключове – чрез FOREIGN KEY.

- Ограниченията за цялостност на базата могат да се описват подробно чрез конструкцията Constraint:
    - Constraint <име на ограничение> <тип> (колона)
    - Constraint <име на ограничение> <тип> (колона) references <име на таблица> (колона)

- Премахването на таблица се извършва чрез командата:
    - DROP TABLE table_name;

    - След нейното изпълнение таблицата не може да се използва, защото нейното описание е изтрито от каталога.

- Команда ALTER
    - Модификации в описанието на вече създадена таблица се извършват чрез командата ALTER TABLE.
    - Тя променя структурата на схемата. 
    - Съществува в няколко варианта и дава възможности за:
        - добавяне / унищожаване на колона;
        - промяна на дефинициите на колона;
        - добавяне / промяна на ограниченията, наложени върху таблицата.

    - При използване на командата за добавяне на нова колона не се допуска използването на ограничението NOT NULL, защото по премълчаване във всички редове на добавената нова колона се записва служебната стойност Null. 
    - Потребителят на базата въвежда реални стойности в новата колона чрез командата UPDATE.

## Работа с вложени изрази
- Основна характеристика на езика SQL се явява възможността за влагането на няколко SELECT-FROM-WHERE израза един в друг.
- Подобни конструкции са необходими при някои задания, където се изисква намирането на определени стойности в базата и използването им в сравнения. 
- Подобни заявки се формулират като вложени блокове след WHERE оператор на друга заявка, наречена външна заявка (outer query). 
- Вложеният SELECT-FROM-WHERE израз се нарича вътрешна заявка (inner query). Нивото на влагане може да е произволно.

- Ако във външната и вложената заявки след оператора FROM се срещат колони с еднакви имена, е необходимо тяхното уточняване чрез синоними. 
- По подразбиране неуточнената колона се свързва с таблицата, указана в най-вътрешния SELECT-FROM-WHERE блок.
- Външната и вложената заявки са независими (некорелирани), когато във вложената заявка не се използват имена на колони от таблицата, зададена във външната заявка.
- Ако във вложената заявка се използва колона, принадлежаща на таблица от външната заявка, двете заявки са свързани помежду си и се наричат зависими (корелирани).

- Сравняване на множества – CONTAINS

- Функция Exists - Проверява дали резултатът на вложена и корелирана заявка съдържа редове или е празно множество

## Допълнителни възможности на SQL
- Задаване на потребителски представи.
- Задаване на общи ограничения във формата на твърдения.
- Разрешаване или отменяне на потребителски права.
- Методология за вграждането на SQL в език за програмиране. 
- Работа с тригери за автоматично предприемане на действия при настъпване на определени събития.
- Задаване на абстрактни типове от данни.
- Връзка с XML.

- Явно задаване на операцията “съединение”
    - Типове съединение:
        - Съединение от общ вид (theta join). 
        - Естествено съединение (natural join). 
        - Ляво-външно съединение (left outer join). 
        - Дясно-външно съединение (right outer join). 
        - Пълно съединение (cross-join), което представлява декартово произведение.
